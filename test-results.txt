
> lifeos-mcp@2.0.1 test
> jest

ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shayon/DevProjects/mcp-for-lifeos/tsconfig.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
PASS tests/integration/jsonl-stress.test.ts (8.18 s)
  JSONL Analytics Stress Tests
    Memory Usage Tests
      âœ“ should maintain stable memory usage during continuous writes (72 ms)
      âœ“ should not leak memory when reading large JSONL files (469 ms)
    Data Integrity Under Load
      âœ“ should maintain data integrity with 10 concurrent processes (1601 ms)
      âœ“ should handle rapid write bursts without data corruption (795 ms)
    Performance Benchmarks
      âœ“ should achieve > 1000 writes per second (5027 ms)
      âœ“ should handle mixed read/write operations efficiently (61 ms)
    Error Recovery
      âœ“ should recover from corrupted JSONL files (3 ms)
      âœ“ should handle file system errors gracefully (2 ms)

PASS tests/integration/mcp-server-concurrent.test.ts
  MCP Server Concurrent Operations
    Multiple Server Instances
      âœ“ should maintain data integrity when servers start and stop frequently (2543 ms)
      â—‹ skipped should handle multiple MCP server instances writing analytics concurrently
    Analytics Collection Behavior
      âœ“ should handle rapid sequential writes without data loss (2127 ms)
      â—‹ skipped should append to existing JSONL file

  console.warn
    Warning: Metric exceeds PIPE_BUF size, atomicity not guaranteed

      557 |       // Warn if over PIPE_BUF (4096 on most systems)
      558 |       if (jsonLine.length > 4096) {
    > 559 |         console.warn('Warning: Metric exceeds PIPE_BUF size, atomicity not guaranteed');
          |                 ^
      560 |       }
      561 |     });
      562 |   });

      at Object.<anonymous> (tests/integration/concurrent-jsonl.test.ts:559:17)

PASS tests/integration/concurrent-jsonl.test.ts
  Concurrent JSONL Integration Tests
    Concurrent Process Writes
      âœ“ should handle 3 concurrent processes with zero data loss (1069 ms)
      âœ“ should maintain line atomicity (no interleaved writes) (624 ms)
      âœ“ should handle process crashes gracefully (490 ms)
    Format Migration
      âœ“ should read existing JSON format while writing JSONL (2 ms)
      âœ“ should auto-detect format based on file extension (1 ms)
    Performance Validation
      âœ“ should complete append operations within 5ms (10 ms)
      âœ“ should handle high-frequency writes efficiently (1019 ms)
    Edge Cases
      âœ“ should handle disk full scenarios gracefully (1 ms)
      âœ“ should handle permission denied errors (1 ms)
      âœ“ should handle very large individual metrics (18 ms)

PASS tests/unit/jsonl-analytics.test.ts
  JSONL Analytics Unit Tests
    Atomic Append Operations
      âœ“ should use fs.appendFileSync for atomic writes (1 ms)
      âœ“ should ensure line size stays under PIPE_BUF (4096 bytes) (1 ms)
      âœ“ should handle write errors gracefully (1 ms)
    JSONL Line Formatting
      âœ“ should format each metric as a single JSON line
      âœ“ should not include multi-line JSON formatting (1 ms)
      âœ“ should escape special characters properly
    Instance ID Generation
      âœ“ should generate unique UUID v4 instance IDs (4 ms)
      âœ“ should include process ID and hostname (1 ms)
      âœ“ should maintain instance ID throughout session
    Malformed Line Parsing
      âœ“ should skip malformed JSON lines (2 ms)
      âœ“ should handle partial lines from process crashes (1 ms)
      âœ“ should handle empty lines and whitespace
    Format Detection (JSON vs JSONL)
      âœ“ should detect format by file extension (1 ms)
      âœ“ should detect format by content structure
      âœ“ should support reading both formats during migration (1 ms)
    Buffer Management
      âœ“ should flush buffer when size limit reached
      âœ“ should flush buffer on timer interval (256 ms)

PASS tests/unit/server/request-handler.test.ts
  Request Handler - isToolAllowed
    Always-available tools
      âœ“ allows always-available tools in legacy-only mode (4 ms)
      âœ“ allows always-available tools in consolidated-only mode
      âœ“ allows always-available tools in consolidated-with-aliases mode (1 ms)
    Consolidated tools
      âœ“ allows consolidated tools in consolidated-only mode
      âœ“ allows consolidated tools in consolidated-with-aliases mode
      âœ“ blocks consolidated tools in legacy-only mode
    Legacy tools
      âœ“ allows legacy tools in legacy-only mode (3 ms)
      âœ“ allows legacy tools in consolidated-with-aliases mode (1 ms)
      âœ“ blocks legacy tools in consolidated-only mode (1 ms)
    Unknown tools
      âœ“ blocks unknown tools in legacy-only mode
      âœ“ blocks unknown tools in consolidated-only mode
      âœ“ blocks unknown tools in consolidated-with-aliases mode (1 ms)
    Edge cases
      âœ“ handles empty tool name
      âœ“ handles case-sensitive tool names
      âœ“ returns structured error message for invalid mode (1 ms)
  Request Handler - validateMaxResults
    Default behavior
      âœ“ returns default value (25) when undefined
    Valid range (1-100)
      âœ“ accepts value within range without adjustment (1 ms)
    Constraint to minimum (1)
      âœ“ constrains negative values to minimum
      âœ“ constrains zero to minimum
    Constraint to maximum (100)
      âœ“ constrains values above 100 (1 ms)
      âœ“ constrains very large values
    Tool name parameter (MCP-95)
      âœ“ accepts any tool name without tool-specific constraints (1 ms)
  Request Handler - createRequestHandler
    Factory creation
      âœ“ creates handler function (1 ms)
      âœ“ creates handler without executing side effects (3 ms)
    Registry population (MCP-96)
      âœ“ throws "Missing arguments" for request without arguments (7 ms)
      âœ“ executes consolidated tools via registry (1 ms)
      âœ“ creates notes via consolidated registry handler (1 ms)
      âœ“ lists data via consolidated registry handler (1 ms)
      âœ“ throws "Unknown tool" when registry lacks tool
      âœ“ validates tool mode before registry lookup
    Tool mode validation
      âœ“ validates tool availability in legacy-only mode (1 ms)
      âœ“ validates tool availability in consolidated-only mode (1 ms)
    Handler context
      âœ“ builds context with provided configuration

PASS tests/unit/task-formatting.test.ts
  Task Formatting with Obsidian Tasks Plugin
    Task Creation Date Formatting
      âœ“ should add creation date to tasks without one (10 ms)
      âœ“ should not add creation date to tasks that already have one (2 ms)
      âœ“ should handle multiple tasks correctly (5 ms)
      âœ“ should not modify non-task list items (3 ms)
      âœ“ should work with daily note task workflow (14 ms)
    Task Properties Formatting
      âœ“ should maintain other task properties when adding creation date (5 ms)

PASS tests/integration/daily-note-task-workflow.test.ts
  Daily Note Task Addition Workflow
    Reproducing Issue #88
      âœ“ should add tasks to existing Day's Notes section (6 ms)
      âœ“ should handle multiple task additions without creating duplicates (7 ms)
      âœ“ should fail gracefully when heading doesn't exist (16 ms)
      âœ“ should handle case variations in Day's Notes (4 ms)
    Task Insertion Order (Issue #90)
      âœ“ should append new tasks at the bottom of existing task lists (4 ms)
      âœ“ should handle mixed content with tasks properly (3 ms)
      âœ“ should insert task at bottom when section has no existing tasks (6 ms)
      âœ“ should NOT insert tasks at the beginning of the section (18 ms)
      âœ“ should handle the exact scenario from issue #90 (3 ms)
      âœ“ should handle case when section has no tasks initially (4 ms)
      âœ“ should handle edge case - heading with no content (2 ms)
    Error Scenarios from RCA
      âœ“ should not create duplicate files when updating daily notes (8 ms)

PASS tests/unit/insert-content.test.ts
  VaultUtils.insertContent
    Heading-based insertion
      âœ“ should insert content after a heading (3 ms)
      âœ“ should insert content before a heading (4 ms)
      âœ“ should handle headings without hash prefix in target (4 ms)
      âœ“ should throw error if heading not found (16 ms)
    Block reference insertion
      âœ“ should insert content after a block reference (2 ms)
      âœ“ should handle block ref without caret prefix (2 ms)
    Pattern-based insertion
      âœ“ should insert content after a text pattern (4 ms)
      âœ“ should throw error if pattern not found (2 ms)
    Line number insertion
      âœ“ should insert content at specific line number (2 ms)
      âœ“ should throw error if line number out of range (2 ms)
    Position options
      âœ“ should append to end of target line (2 ms)
      âœ“ should prepend to beginning of target line (6 ms)
    Newline handling
      âœ“ should ensure newlines by default (3 ms)
      âœ“ should not add newlines when disabled (2 ms)

PASS tests/unit/response-truncator.test.ts
  ResponseTruncator
    Constructor and Initialization
      âœ“ should create with default configuration (1 ms)
      âœ“ should create with custom configuration (1 ms)
      âœ“ should merge custom config with defaults (3 ms)
      âœ“ should validate configuration on creation (7 ms)
    Budget Tracking
      âœ“ should track remaining budget correctly
      âœ“ should never return negative remaining budget
      âœ“ should accumulate consumed budget across multiple calls (1 ms)
      âœ“ should reset budget to initial state
    canAddResult()
      âœ“ should return true when result fits within budget
      âœ“ should return false when result exceeds budget (1 ms)
      âœ“ should return true when result exactly fits budget
      âœ“ should account for already consumed budget
      âœ“ should handle empty string (1 ms)
    consumeBudget()
      âœ“ should consume budget for valid result
      âœ“ should throw error when result would exceed budget (1 ms)
      âœ“ should throw error with accurate exceeded amount
      âœ“ should not modify budget if consumption throws
      âœ“ should handle empty string without error
    estimateTokens()
      âœ“ should estimate tokens using configured ratio
      âœ“ should round up fractional tokens (5 ms)
      âœ“ should handle custom estimation ratios
      âœ“ should handle empty string
      âœ“ should handle unicode characters correctly (1 ms)
    getTruncationInfo()
      âœ“ should generate metadata when not truncated
      âœ“ should generate metadata when truncated by token budget (1 ms)
      âœ“ should include standard suggestion message
      âœ“ should include auto-downgrade suggestion when applicable
      âœ“ should calculate estimated tokens correctly (1 ms)
      âœ“ should set limitType to "token" when token was constraint
    Edge Cases and Boundary Conditions
      âœ“ should handle maxResults=1 (minimum)
      âœ“ should handle maxResults=100 (maximum)
      âœ“ should handle single result exceeding budget
      âœ“ should handle exactly at budget boundary
    Factory Functions
      âœ“ should create default truncator via factory (1 ms)
      âœ“ should create custom truncator via factory
  Configuration Validation
    validateTokenBudgetConfig()
      âœ“ should accept valid configuration
      âœ“ should reject negative maxTokens (1 ms)
      âœ“ should reject zero maxTokens
      âœ“ should reject negative maxCharacters
      âœ“ should reject negative estimationRatio (3 ms)
      âœ“ should reject inconsistent maxCharacters and maxTokens
      âœ“ should allow reasonable tolerance in consistency check (1 ms)
    validateMaxResults()
      âœ“ should return default for undefined value (search)
      âœ“ should return default for undefined value (list)
      âœ“ should return default for undefined value (yaml_properties)
      âœ“ should accept valid value within range (1 ms)
      âœ“ should constrain value below minimum
      âœ“ should constrain value above maximum
      âœ“ should constrain negative values (1 ms)
  Real-World Scenarios
    Incremental Result Accumulation
      âœ“ should simulate typical search result accumulation (1 ms)
      âœ“ should handle very large result that fits exactly
      âœ“ should prevent adding second result after budget consumed (1 ms)
    Performance Characteristics
      âœ“ should handle character estimation efficiently (1 ms)
      âœ“ should track budget for many small results efficiently (1 ms)

PASS tests/integration/daily-note-simple.test.ts
  Daily Note Template Integration (Direct)
    Daily note creation with templates
      âœ“ should create daily note using configured template (13 ms)
      âœ“ should handle different date formats (9 ms)
      âœ“ should create weekly template when specified (8 ms)
      âœ“ should handle missing template gracefully (13 ms)
      âœ“ should apply template caching (5 ms)
    Template processing edge cases
      âœ“ should handle malformed template syntax (7 ms)
      âœ“ should handle complex date formatting (5 ms)
      âœ“ should handle nested folders in template path (5 ms)
    VaultUtils integration
      âœ“ should create daily note with VaultUtils (9 ms)

PASS tests/unit/insert-content-sections.test.ts
  Insert Content - Section Targeting
    Daily Note - Day's Notes Section
      âœ“ should find "Day's Notes" heading correctly (28 ms)
      âœ“ should handle exact heading matching with hash prefix (8 ms)
      âœ“ should add multiple tasks to the same section (12 ms)
      âœ“ should throw error for non-existent heading (46 ms)
      âœ“ should handle case sensitivity correctly (71 ms)
    Template Variations
      âœ“ should handle template with "Days Notes" (no apostrophe) (12 ms)
      âœ“ should handle template with different heading levels (13 ms)

PASS tests/unit/mcp-server-factory.test.ts
  MCP Server Factory
    isValidToolMode
      âœ“ should return true for valid tool modes (4 ms)
      âœ“ should return false for invalid tool modes (2 ms)
    parseToolMode
      âœ“ should use TOOL_MODE when set to valid value
      âœ“ should fallback to default when TOOL_MODE is invalid (1 ms)
      âœ“ should use CONSOLIDATED_TOOLS_ENABLED for backward compatibility (1 ms)
      âœ“ should prefer TOOL_MODE over CONSOLIDATED_TOOLS_ENABLED (1 ms)
      âœ“ should default to consolidated-only when no env vars set (1 ms)
    generateSessionId
      âœ“ should generate valid UUID (1 ms)
      âœ“ should generate unique IDs (1 ms)
    extractClientInfo
      âœ“ should extract client name and version from server
      âœ“ should handle undefined client version
      âœ“ should handle partial client info (missing version) (1 ms)
      âœ“ should handle partial client info (missing name)
      âœ“ should extract info from multiple server instances consistently
      âœ“ should handle real-world client names (3 ms)
    createMcpServer
      âœ“ should create server with minimal config (6 ms)
      âœ“ should throw error for invalid vaultPath (19 ms)
      âœ“ should throw error for non-existent vaultPath (2 ms)
      âœ“ should throw error for inaccessible vaultPath
      âœ“ should use provided server name and version (1 ms)
      âœ“ should use default server name and version (3 ms)
      âœ“ should accept explicit tool mode (1 ms)
      âœ“ should parse tool mode from environment (4 ms)
      âœ“ should accept custom session ID (1 ms)
      âœ“ should generate session ID if not provided
      âœ“ should create stdio transport by default (7 ms)
      âœ“ should not create stdio transport when disabled (3 ms)
      âœ“ should return instance with lifecycle methods (2 ms)
    Server Factory Integration
      âœ“ should create server instance conforming to McpServerInstance contract (3 ms)
      âœ“ should share analytics singleton across instances (1 ms)

PASS tests/unit/path-utils.test.ts
  path-utils
    MD_EXTENSION_REGEX constant
      âœ“ should match .md extension at end of string (1 ms)
      âœ“ should not match .md in middle of filename
      âœ“ should match only final .md in double extension (1 ms)
    stripMdExtension
      basic functionality
        âœ“ should strip .md extension from filename (2 ms)
        âœ“ should return filename unchanged when no .md extension
      edge cases
        âœ“ should handle empty string (1 ms)
        âœ“ should strip only final .md from double extension
        âœ“ should preserve .md in middle of filename
        âœ“ should not strip non-.md extensions (1 ms)
        âœ“ should handle multiple dots in filename
      path preservation
        âœ“ should preserve relative directory paths (2 ms)
        âœ“ should preserve absolute directory paths
        âœ“ should preserve paths with multiple dots
        âœ“ should handle paths with no extension
      pure function behavior
        âœ“ should not modify input parameter (1 ms)
        âœ“ should return consistent results for same input
        âœ“ should work with const inputs
      real-world use cases
        âœ“ should handle daily note filenames
        âœ“ should handle template filenames (1 ms)
        âœ“ should handle vault paths
        âœ“ should handle special characters in filenames (1 ms)
    normalizePath
      absolute path handling
        âœ“ should return absolute POSIX path as-is
        âœ“ should return absolute Windows path as-is (Windows only)
        âœ“ should return UNC network path as-is (Windows only) (1 ms)
        âœ“ should not modify absolute paths regardless of basePath
      relative path handling
        âœ“ should join relative POSIX path with basePath
        âœ“ should join relative Windows path with basePath
        âœ“ should handle simple relative paths (1 ms)
      cross-platform path detection
        âœ“ should correctly identify POSIX absolute paths
        âœ“ should correctly identify Windows absolute paths
        âœ“ should correctly identify relative paths (1 ms)
      path traversal edge cases
        âœ“ should handle path traversal attempts
        âœ“ should preserve path traversal in relative paths
      real-world vault scenarios
        âœ“ should handle absolute dailyNotesPath from LIFEOS_CONFIG
        âœ“ should handle relative template inference paths
        âœ“ should handle relative user input paths (4 ms)
        âœ“ should handle paths with spaces
      pure function behavior
        âœ“ should not modify input parameters (1 ms)
        âœ“ should return consistent results for same input
        âœ“ should be deterministic
      no I/O operations
        âœ“ should not check if paths exist
        âœ“ should work with invalid paths (1 ms)
      escaped space handling (MCP-64)
        âœ“ should convert escaped spaces to regular spaces
        âœ“ should handle multiple escaped spaces (1 ms)
        âœ“ should handle escaped spaces in absolute paths
        âœ“ should preserve regular spaces (non-escaped)
        âœ“ should handle CLI compatibility scenario
        âœ“ should not affect paths without escaped spaces (1 ms)
      path traversal validation (MCP-64)
        âœ“ should allow paths within vault when validation disabled (default)
        âœ“ should allow paths within vault when validation enabled
        âœ“ should throw error for path traversal when validation enabled (8 ms)
        âœ“ should throw error for absolute path outside vault when validation enabled
        âœ“ should allow path traversal when validation disabled (default)
        âœ“ should provide detailed error message for path traversal
        âœ“ should handle vault root path correctly
        âœ“ should handle current directory reference
        âœ“ should detect sibling directory attack with absolute path (3 ms)
        âœ“ should detect vault prefix attack without separator
      combined features (MCP-64)
        âœ“ should handle escaped spaces with path traversal validation (3 ms)
        âœ“ should detect traversal even with escaped spaces
        âœ“ should handle complex real-world path with all features

FAIL tests/unit/server/legacy-alias-handlers.test.ts
  Legacy Alias Handlers Module
    LEGACY_ALIAS_TOOL_NAMES constant
      âœ“ should export exactly 11 legacy alias tool names (1 ms)
      âœ“ should include all search aliases (6 total) (3 ms)
      âœ“ should include template alias
      âœ“ should include all list aliases (4 total) (1 ms)
    registerLegacyAliasHandlers()
      âœ“ should register all 11 legacy alias handlers into the registry
      âœ“ should register handlers for each tool in LEGACY_ALIAS_TOOL_NAMES (1 ms)
      âœ“ should support chaining pattern (1 ms)
      âœ“ should be idempotent (multiple calls don't duplicate handlers)
    getLegacyAliasHandler()
      âœ“ should return handler for valid legacy alias tool names (1 ms)
      âœ“ should return undefined for unknown tool names (1 ms)
      âœ“ should return the same handler instance on multiple calls
    Mode Guards
      âœ• should throw error when called in legacy-only mode (search aliases) (712 ms)
      âœ• should throw error when called in legacy-only mode (template alias) (3 ms)
      âœ• should throw error when called in legacy-only mode (list aliases) (6 ms)
    Handler Factory Initialization
      âœ“ should initialize handlers lazily (only on first access) (1 ms)
      âœ“ should create separate handler instances for each tool
    Deprecation Warning Generation
      âœ“ should include deprecation notice in handler response structure (1 ms)

  â— Legacy Alias Handlers Module â€º Mode Guards â€º should throw error when called in legacy-only mode (search aliases)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"content": [[Object]], "metadata": {"serverName": "lifeos-mcp", "toolMode": "consolidated-with-aliases", "version": "2.0.1"}}

      148 |       };
      149 |
    > 150 |       await expect(
          |             ^
      151 |         handler!({ query: 'test' }, legacyOnlyContext)
      152 |       ).rejects.toThrow('This handler should only be called in non-legacy modes');
      153 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/server/legacy-alias-handlers.test.ts:150:13)

  â— Legacy Alias Handlers Module â€º Mode Guards â€º should throw error when called in legacy-only mode (template alias)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"content": [{"text": "âš ï¸ **DEPRECATION NOTICE**: The `create_note_from_template` tool is deprecated. Please use `create_note` instead.Â·
    âœ… Created note: **Test**Â·
    ðŸ”— [Open in Obsidian: Test](obsidian://open?vault=LifeOS%20(iCloud)&file=05%20-%20Fleeting%20Notes%2FTest.md)Â·
    ðŸ“ Location: `05 - Fleeting Notes/Test.md`
    ðŸ”§ Template: default", "type": "text"}], "metadata": {"serverName": "lifeos-mcp", "toolMode": "consolidated-with-aliases", "version": "2.0.1"}}

      162 |       };
      163 |
    > 164 |       await expect(
          |             ^
      165 |         handler!({ title: 'Test', template: 'default' }, legacyOnlyContext)
      166 |       ).rejects.toThrow('This handler should only be called in non-legacy modes');
      167 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/server/legacy-alias-handlers.test.ts:164:13)

  â— Legacy Alias Handlers Module â€º Mode Guards â€º should throw error when called in legacy-only mode (list aliases)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"content": [{"text": "âš ï¸ **DEPRECATION NOTICE**: The `list_folders` tool is deprecated. Please use `list` with type=\"folders\" instead.Â·
    Folders in vault root:Â·
    ðŸ“ .claude
    ðŸ“ .copilot
    ðŸ“ .git
    ðŸ“ .github
    ðŸ“ .iPhone
    ðŸ“ .obsidian
    ðŸ“ .smtcmp_json_db
    ðŸ“ .trash
    ðŸ“ .vscode
    ðŸ“ 00 - Meta
    ðŸ“ 05 - Fleeting Notes
    ðŸ“ 10 - Projects
    ðŸ“ 20 - Areas
    ðŸ“ 30 - Resources
    ðŸ“ 40 - Archives
    ðŸ“ copilot", "type": "text"}], "metadata": {"serverName": "lifeos-mcp", "toolMode": "consolidated-with-aliases", "version": "2.0.1"}}

      176 |       };
      177 |
    > 178 |       await expect(
          |             ^
      179 |         handler!({}, legacyOnlyContext)
      180 |       ).rejects.toThrow('This handler should only be called in non-legacy modes');
      181 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/server/legacy-alias-handlers.test.ts:178:13)

PASS tests/unit/date-resolver.test.ts
  DateResolver
    resolveDailyNoteDate
      âœ“ should handle "today" keyword (9 ms)
      âœ“ should handle "yesterday" keyword
      âœ“ should handle "tomorrow" keyword (1 ms)
      âœ“ should handle relative date formats (43 ms)
      âœ“ should handle weekday names (1 ms)
      âœ“ should handle YYYY-MM-DD format (1 ms)
      âœ“ should handle various date formats (1 ms)
      âœ“ should default to today for empty input (1 ms)
      âœ“ should handle invalid dates gracefully (5 ms)
      âœ“ should handle ISO date strings (1 ms)
      â—‹ skipped should handle "last" weekday names
    relative date handling through resolveDailyNoteDate
      âœ“ should handle positive relative dates (1 ms)
      âœ“ should handle negative relative dates (3 ms)
    weekday handling through resolveDailyNoteDate
      âœ“ should find next occurrence of weekday (2 ms)
      âœ“ should handle case insensitively (1 ms)
    timezone handling
      âœ“ should use local timezone for date resolution (2 ms)
    edge cases
      âœ“ should handle month boundaries correctly (1 ms)
      âœ“ should handle year boundaries correctly (1 ms)
      âœ“ should handle leap years correctly (1 ms)

  console.warn
    [ObsidianLinks] extractNoteTitle: Invalid or empty filename for path "/vault/.md". Returning empty string as title.

      109 |     // Edge case: Handle empty filename (e.g., '/vault/.md' -> basename returns '.md')
      110 |     if (!filename || filename === '.md') {
    > 111 |       console.warn(`[ObsidianLinks] extractNoteTitle: Invalid or empty filename for path "${filePath}". Returning empty string as title.`);
          |               ^
      112 |       return '';
      113 |     }
      114 |

      at Function.extractNoteTitle (src/obsidian-links.ts:111:15)
      at Object.<anonymous> (tests/unit/obsidian-links.test.ts:234:36)

PASS tests/unit/obsidian-links.test.ts
  ObsidianLinks.extractNoteTitle()
    Priority 1: Frontmatter title field
      âœ“ should prioritize frontmatter.title when provided and non-empty (4 ms)
      âœ“ should use frontmatter.title even for daily note filenames (2 ms)
      âœ“ should handle frontmatter with Record<string, any> type (1 ms)
      âœ“ should ignore empty string frontmatter.title
      âœ“ should ignore whitespace-only frontmatter.title (1 ms)
      âœ“ should handle non-string frontmatter.title
    Priority 2: Daily note date formatting (YYYY-MM-DD)
      âœ“ should format daily notes as "Month DD, YYYY"
      âœ“ should handle timezone correctly - MCP-31 FIX (parseISO vs new Date)
      âœ“ should handle leap year daily notes (1 ms)
      âœ“ should handle daily notes without frontmatter parameter
      âœ“ should handle daily notes with empty frontmatter object
      âœ“ should only match YYYY-MM-DD format exactly (1 ms)
    Priority 3: Title-cased filename transformation
      âœ“ should transform dashes to spaces (1 ms)
      âœ“ should transform underscores to spaces
      âœ“ should transform mixed dashes and underscores
      âœ“ should apply title case to each word
      âœ“ should handle single word filenames (1 ms)
      âœ“ should handle filenames with numbers
      âœ“ should remove .md extension
    Edge Cases and Error Handling
      âœ“ should handle missing frontmatter parameter (undefined) (1 ms)
      âœ“ should handle null frontmatter
      âœ“ should handle frontmatter without title field (1 ms)
      âœ“ should handle absolute paths
      âœ“ should handle relative paths (1 ms)
      âœ“ should handle paths without extension
      âœ“ should handle empty filename (edge case) (17 ms)
      âœ“ should handle paths with multiple dots
    Backward Compatibility
      âœ“ should work without frontmatter parameter (original signature) (1 ms)
      âœ“ should work with frontmatter parameter (enhanced signature)
    Real-World Scenarios
      âœ“ should handle typical daily note without custom title
      âœ“ should handle project note with custom title (1 ms)
      âœ“ should handle article note with title
      âœ“ should handle meeting note without custom title

PASS tests/integration/claude-desktop-integration.test.ts
  Claude Desktop Integration (Direct)
    Core MCP-61 Test: No Production Vault Pollution
      âœ“ should create notes ONLY in temp vault, never in production (49 ms)
    Vault Isolation Verification
      âœ“ should read/write/search only in temp vault (12 ms)
    Config Override Verification
      âœ“ should use temp vault paths from LIFEOS_CONFIG (5 ms)
    Cleanup Verification
      âœ“ should clean up temp vault in afterEach (10 ms)

PASS tests/integration/request-handler-empty-registry.test.ts
  Request Handler - Consolidated Registry Integration (MCP-96)
    Consolidated execution
      âœ“ returns versioned response for consolidated search tool (3 ms)
      âœ“ updates analytics client info when updateClientContext is invoked (6 ms)
    Availability checks
      âœ“ rejects unknown tools with descriptive error (8 ms)
      âœ“ blocks consolidated tools in legacy-only mode before lookup (1 ms)
      âœ“ blocks legacy tools in consolidated-only mode (1 ms)

PASS tests/unit/template-manager.test.ts
  TemplateManager
    getTemplateNames
      âœ“ should return template names from cache when valid (5 ms)
      âœ“ should refresh cache when expired (1 ms)
      âœ“ should handle missing template folder gracefully (1 ms)
    getTemplate
      âœ“ should load template content from file (1 ms)
      âœ“ should return null for non-existent template (1 ms)
      âœ“ should handle template with .md extension
    getDailyNoteTemplate
      âœ“ should return daily note template name from settings
      âœ“ should return null when no template configured (1 ms)
    processTemplate
      âœ“ should process template with context (1 ms)
      âœ“ should return null for non-existent template (3 ms)
    caching behavior
      âœ“ should reuse cache within expiry period (2 ms)
      âœ“ should handle errors gracefully (5 ms)

PASS tests/integration/jsonl-final-validation.test.ts
  JSONL Analytics Final Validation
    Production File Analysis
      âœ“ should validate existing JSONL file structure (60 ms)
      âœ“ should verify backward compatibility with JSON format (1 ms)
    Instance Identification
      â—‹ skipped should generate unique instance IDs for each server start
    Concurrent Safety
      âœ“ should validate no data corruption in production JSONL file (2 ms)
      âœ“ should verify atomicity of recent writes (2 ms)
    Performance Characteristics
      âœ“ should measure append performance on actual analytics file (8 ms)
      âœ“ should measure file size growth characteristics (1 ms)

PASS tests/unit/date-resolver-timezone.test.ts
  DateResolver - Timezone Edge Cases
    midnight boundary crossing
      âœ“ should handle "today" correctly near midnight UTC (4 ms)
      âœ“ should handle "today" correctly just after midnight UTC (1 ms)
    DST transitions
      âœ“ should handle spring forward DST transition (1 ms)
      âœ“ should handle fall back DST transition
    extreme timezone differences
      âœ“ should handle Pacific/Kiritimati (UTC+14) (1 ms)
      âœ“ should handle Pacific/Midway (UTC-11)
    user scenario simulations
      âœ“ should handle late night work session in EST (1 ms)
      âœ“ should handle morning work session in various timezones (1 ms)
    relative dates across timezone boundaries
      âœ“ should calculate "yesterday" correctly across timezones
      âœ“ should calculate relative offsets correctly (1 ms)

PASS tests/integration/token-limited-search.test.ts
  Token-Limited Search Integration
    ObsidianLinks with Token Budget
      âœ“ should format search result and consume budget (1 ms)
      âœ“ should format in detailed mode with token budget (1 ms)
      âœ“ should handle multiple results with budget tracking (2 ms)
      âœ“ should stop adding results when budget exhausted (1 ms)
    maxResults Parameter Validation
      âœ“ should constrain minimum maxResults to 1 (1 ms)
      âœ“ should constrain maximum maxResults to 100 (1 ms)
      âœ“ should accept valid range 1-100 (1 ms)
      âœ“ should return default when undefined
    Truncation Metadata Generation
      âœ“ should generate metadata when results truncated (1 ms)
      âœ“ should indicate no truncation when all results shown
      âœ“ should indicate auto-downgrade in suggestion (1 ms)
    End-to-End Scenarios
      âœ“ should handle search with maxResults constraint
      âœ“ should handle search with token budget constraint (1 ms)
      âœ“ should handle combined maxResults and token budget constraints
      âœ“ should provide accurate truncation metadata after processing (1 ms)
    Format Switching Impact
      âœ“ should show that detailed format consumes more budget than concise
      âœ“ should fit more results in concise mode than detailed mode
    Error Handling
      âœ“ should not throw when adding results within budget (1 ms)
      âœ“ should gracefully handle empty search results

PASS tests/integration/legacy-alias-handlers.test.ts
  Legacy Alias Handlers Integration
    Search Alias Parameter Mapping
      âœ“ search_by_content_type should map contentType to query parameter (5 ms)
      âœ“ find_notes_by_pattern should map pattern to query parameter (1 ms)
      âœ“ search_notes should use advanced mode (1 ms)
      âœ“ quick_search should use quick mode (1 ms)
      âœ“ search_recent should use recent mode
    List Alias Parameter Mapping
      âœ“ list_folders should map path parameter
      âœ“ list_daily_notes should map limit parameter
      âœ“ list_yaml_properties should map all parameters (1 ms)
    Template Alias Integration
      âœ“ create_note_from_template should set auto_template to false
    Deprecation Warning Presence
      âœ“ search aliases should include deprecation warning in response (1 ms)
      âœ“ template alias should include deprecation warning in response
      âœ“ list aliases should include deprecation warning in response
    Version Metadata Integration
      âœ“ should include version metadata when enabled in registry config

PASS tests/unit/query-parser.test.ts
  QueryParser
    extractTerms
      âœ“ should extract single word (1 ms)
      âœ“ should extract multiple words (1 ms)
      âœ“ should handle quoted strings as single term (1 ms)
      âœ“ should handle mixed quoted and unquoted
      âœ“ should handle extra whitespace (1 ms)
      âœ“ should handle empty string
    hasRegexChars
      âœ“ should detect regex special chars (20 ms)
      âœ“ should not flag spaces as regex chars (1 ms)
      âœ“ should not flag normal text (1 ms)
    isQuoted
      âœ“ should detect quoted strings (1 ms)
      âœ“ should not detect unquoted strings (1 ms)
      âœ“ should not detect partial quotes
    detectStrategy
      âœ“ should detect exact_phrase for quoted strings (1 ms)
      âœ“ should detect any_term for OR queries (1 ms)
      âœ“ should detect exact_phrase for 1-2 word queries (1 ms)
      âœ“ should detect all_terms for 3+ word queries
      âœ“ should prioritize quotes over word count
      âœ“ should prioritize OR over word count (1 ms)
    parse
      âœ“ should parse simple query (1 ms)
      âœ“ should parse multi-word query
      âœ“ should parse quoted query (1 ms)
      âœ“ should parse OR query
      âœ“ should detect regex chars
    createPatterns
      exact_phrase strategy
        âœ“ should create single pattern for sequential match (1 ms)
        âœ“ should respect case sensitivity
      all_terms strategy
        âœ“ should create lookahead pattern for all terms (2 ms)
        âœ“ should use word boundaries (1 ms)
      any_term strategy
        âœ“ should create alternation pattern for any term (1 ms)
        âœ“ should use word boundaries
      auto strategy
        âœ“ should fallback to exact_phrase for auto (1 ms)
    Bug Regression: MCP-59
      âœ“ should handle "trip to india november planning" with all_terms (1 ms)
      âœ“ should maintain exact_phrase for "India trip"

PASS tests/unit/server/tool-registry.test.ts
  Tool Registry
    getConsolidatedTools()
      âœ“ should return exactly 3 consolidated tools (1 ms)
      âœ“ should have valid tool structure (1 ms)
    getLegacyTools()
      âœ“ should return exactly 11 legacy tools
      âœ“ should not have deprecation notices in descriptions (1 ms)
    getLegacyAliases()
      âœ“ should return exactly 11 legacy aliases
      âœ“ should have deprecation notices in descriptions (1 ms)
      âœ“ should share schemas with legacy tools (4 ms)
    getAlwaysAvailableTools()
      âœ“ should return exactly 9 always-available tools (1 ms)
      âœ“ should include core tools (1 ms)
    getToolsForMode()
      âœ“ should return 12 tools for consolidated-only mode (4 ms)
      âœ“ should return 20 tools for legacy-only mode (1 ms)
      âœ“ should return 34 tools for consolidated-with-aliases mode
      âœ“ should throw error for invalid mode (10 ms)
      âœ“ should include always-available tools in all modes (1 ms)
    addVersionMetadata()
      âœ“ should add metadata to response (1 ms)
      âœ“ should preserve existing metadata
      âœ“ should not mutate original response

PASS tests/unit/search-engine.test.ts
  SearchEngine MCP-59 regressions
    âœ“ returns matches for all_terms queries after evaluating multiple notes (4 ms)

Summary of all failing tests
FAIL tests/unit/server/legacy-alias-handlers.test.ts
  â— Legacy Alias Handlers Module â€º Mode Guards â€º should throw error when called in legacy-only mode (search aliases)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"content": [[Object]], "metadata": {"serverName": "lifeos-mcp", "toolMode": "consolidated-with-aliases", "version": "2.0.1"}}

      148 |       };
      149 |
    > 150 |       await expect(
          |             ^
      151 |         handler!({ query: 'test' }, legacyOnlyContext)
      152 |       ).rejects.toThrow('This handler should only be called in non-legacy modes');
      153 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/server/legacy-alias-handlers.test.ts:150:13)

  â— Legacy Alias Handlers Module â€º Mode Guards â€º should throw error when called in legacy-only mode (template alias)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"content": [{"text": "âš ï¸ **DEPRECATION NOTICE**: The `create_note_from_template` tool is deprecated. Please use `create_note` instead.Â·
    âœ… Created note: **Test**Â·
    ï¿½ï¿½ [Open in Obsidian: Test](obsidian://open?vault=LifeOS%20(iCloud)&file=05%20-%20Fleeting%20Notes%2FTest.md)Â·
    ï¿½ï¿½ Location: `05 - Fleeting Notes/Test.md`
    ï¿½ï¿½ Template: default", "type": "text"}], "metadata": {"serverName": "lifeos-mcp", "toolMode": "consolidated-with-aliases", "version": "2.0.1"}}

      162 |       };
      163 |
    > 164 |       await expect(
          |             ^
      165 |         handler!({ title: 'Test', template: 'default' }, legacyOnlyContext)
      166 |       ).rejects.toThrow('This handler should only be called in non-legacy modes');
      167 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/server/legacy-alias-handlers.test.ts:164:13)

  â— Legacy Alias Handlers Module â€º Mode Guards â€º should throw error when called in legacy-only mode (list aliases)

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"content": [{"text": "âš ï¸ **DEPRECATION NOTICE**: The `list_folders` tool is deprecated. Please use `list` with type=\"folders\" instead.Â·
    Folders in vault root:Â·
    ï¿½ï¿½ .claude
    ï¿½ï¿½ .copilot
    ï¿½ï¿½ .git
    ï¿½ï¿½ .github
    ï¿½ï¿½ .iPhone
    ï¿½ï¿½ .obsidian
    ï¿½ï¿½ .smtcmp_json_db
    ï¿½ï¿½ .trash
    ï¿½ï¿½ .vscode
    ï¿½ï¿½ 00 - Meta
    ï¿½ï¿½ 05 - Fleeting Notes
    ï¿½ï¿½ 10 - Projects
    ï¿½ï¿½ 20 - Areas
    ï¿½ï¿½ 30 - Resources
    ï¿½ï¿½ 40 - Archives
    ï¿½ï¿½ copilot", "type": "text"}], "metadata": {"serverName": "lifeos-mcp", "toolMode": "consolidated-with-aliases", "version": "2.0.1"}}

      176 |       };
      177 |
    > 178 |       await expect(
          |             ^
      179 |         handler!({}, legacyOnlyContext)
      180 |       ).rejects.toThrow('This handler should only be called in non-legacy modes');
      181 |     });

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (tests/unit/server/legacy-alias-handlers.test.ts:178:13)


Test Suites: 1 failed, 25 passed, 26 total
Tests:       3 failed, 4 skipped, 447 passed, 454 total
Snapshots:   0 total
Time:        20.941 s
Ran all test suites.
