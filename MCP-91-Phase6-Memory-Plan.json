{
  "phase": "6-memory-prep",
  "status": "success",
  "analysis_date": "2025-11-04",
  "total_memories": 17,
  "memories_analyzed": 7,
  "vaultutils_references_found": 8,
  "memories_to_update": [
    {
      "file": ".serena/memories/vault_integration_patterns.md",
      "current_lines": 230,
      "vaultutils_references": [
        {
          "line": 126,
          "context": "class VaultUtils { static normalizePath(...) }",
          "type": "code_example"
        },
        {
          "line": 195,
          "context": "VaultUtils.writeFileWithRetry(): Atomic file writes",
          "type": "reference"
        }
      ],
      "reference_count": 2,
      "changes": [
        "Replace VaultUtils.normalizePath() example with FilesModule.normalizePath()",
        "Update write resilience pattern to show writeFileWithRetry() from files module",
        "Add new section: 'Post-MCP-91: Domain Module Pattern'"
      ],
      "new_sections": [
        "Post-MCP-91: Domain Module Architecture",
        "Files Module Direct Usage (Recommended)",
        "Migration from VaultUtils Facade"
      ],
      "severity": "medium",
      "impact": "Central architectural reference - updates needed for consistency"
    },
    {
      "file": ".serena/memories/code_quality_patterns.md",
      "current_lines": 239,
      "vaultutils_references": [
        {
          "line": 92,
          "context": "const normalizedPath = VaultUtils.normalizePath(...)",
          "type": "code_example"
        }
      ],
      "reference_count": 1,
      "changes": [
        "Update Pattern 1 'Centralized Utilities' example to use FilesModule directly",
        "Add context explaining facade removal in MCP-91",
        "Keep DRY principle, show new pattern for cross-cutting concerns"
      ],
      "new_sections": [
        "Post-MCP-91: Direct Domain Module Patterns"
      ],
      "severity": "low",
      "impact": "Code quality guidance - example needs updating, principle remains valid"
    },
    {
      "file": ".serena/memories/obsidian_integration.md",
      "current_lines": 230,
      "vaultutils_references": [
        {
          "line": 62,
          "context": "class VaultUtils { static normalizePath(...) }",
          "type": "code_example"
        }
      ],
      "reference_count": 1,
      "changes": [
        "Update 'Path Normalization' section to show FilesModule.normalizePath() usage",
        "Update 'Vault Operations' section to reference files module instead of VaultUtils"
      ],
      "new_sections": [
        "Files Module: Direct Integration",
        "Architecture Evolution in MCP-91"
      ],
      "severity": "medium",
      "impact": "Integration guide - path normalization is core operation"
    },
    {
      "file": ".serena/memories/testing_guide.md",
      "current_lines": 250,
      "vaultutils_references": [
        {
          "line": 65,
          "context": "import { VaultUtils } from '../../src/vault-utils.js'",
          "type": "import"
        },
        {
          "line": 73,
          "context": "VaultUtils.resetSingletons();",
          "type": "singleton_reset"
        },
        {
          "line": 130,
          "context": "VaultUtils.resetSingletons(); // Critical for test isolation",
          "type": "singleton_reset"
        },
        {
          "line": 143,
          "context": "VaultUtils.resetSingletons(); // Force re-initialization with test config",
          "type": "singleton_reset"
        },
        {
          "line": 177,
          "context": "Always call VaultUtils.resetSingletons() after modifying LIFEOS_CONFIG",
          "type": "guidance"
        }
      ],
      "reference_count": 5,
      "changes": [
        "Update all VaultUtils imports to use domain modules (FilesModule, TemplateManager, etc.)",
        "Replace VaultUtils.resetSingletons() with individual module singleton resets",
        "Add new testing patterns for domain module initialization",
        "Update 'Singleton Handling' section with post-MCP-91 singleton management"
      ],
      "new_sections": [
        "Domain Module Testing Patterns",
        "Post-MCP-91 Singleton Management",
        "Module-Level Initialization"
      ],
      "severity": "high",
      "impact": "Critical for test maintenance - singleton reset pattern is actively used"
    },
    {
      "file": ".serena/memories/wal_transaction_patterns.md",
      "current_lines": 207,
      "vaultutils_references": [
        {
          "line": 195,
          "context": "VaultUtils.writeFileWithRetry(): Atomic file writes",
          "type": "integration_reference"
        }
      ],
      "reference_count": 1,
      "changes": [
        "Update Integration Points section to reference FilesModule.writeFileWithRetry()",
        "Add context about facade elimination in MCP-91"
      ],
      "new_sections": [],
      "severity": "low",
      "impact": "Integration documentation - minor reference, principle unchanged"
    }
  ],
  "memories_clean": [
    ".serena/memories/error_handling_patterns.md",
    ".serena/memories/mcp_protocol_patterns.md",
    ".serena/memories/tool_router_patterns.md",
    ".serena/memories/project_context.md",
    ".serena/memories/code_style_conventions.md",
    ".serena/memories/configuration_patterns.md",
    ".serena/memories/documentation_workflow.md",
    ".serena/memories/memory_management.md",
    ".serena/memories/performance_search_patterns.md",
    ".serena/memories/project_overview.md",
    ".serena/memories/suggested_commands.md",
    ".serena/memories/task_completion_checklist.md"
  ],
  "replacement_patterns": {
    "vaultutils_normalizepath": {
      "old": "class VaultUtils {\n  static normalizePath(notePath: string, vaultPath: string): string",
      "new": "class FilesModule {\n  static normalizePath(notePath: string, vaultPath: string): string",
      "rationale": "Path normalization is Files module responsibility"
    },
    "vaultutils_writefileretry": {
      "old": "VaultUtils.writeFileWithRetry(path, content, options)",
      "new": "writeFileWithRetry(path, content, options) from files/utils.ts",
      "rationale": "Atomic writes are Files module responsibility, no facade needed"
    },
    "vaultutils_singleton_reset": {
      "old": "VaultUtils.resetSingletons()",
      "new": "Individual module resets: TemplateManager.reset(), ObsidianSettings.reset(), DateResolver.reset()",
      "rationale": "Each module manages its own singleton lifecycle"
    }
  },
  "update_strategy": {
    "phase_order": [
      "1. Update testing_guide.md (critical for test infrastructure)",
      "2. Update vault_integration_patterns.md (core patterns reference)",
      "3. Update obsidian_integration.md (integration guide)",
      "4. Update wal_transaction_patterns.md (supporting pattern)",
      "5. Update code_quality_patterns.md (principles remain, examples update)"
    ],
    "validation_points": [
      "No VaultUtils imports remain in examples",
      "All domain module references are accurate",
      "New sections add 20-30 lines per memory",
      "Total lines per memory stays within 250-line limit",
      "Cross-references between memories remain valid"
    ]
  },
  "new_content_to_add": {
    "facade_elimination_pattern": {
      "description": "Post-MCP-91: Facade Elimination Success Story",
      "key_learnings": [
        "Single-purpose modules more testable than monolithic facades",
        "Singleton management simpler per-module than centralized",
        "Direct imports improve code clarity and navigation",
        "Configuration isolation prevents singleton leak"
      ],
      "where_to_add": [
        "code_quality_patterns.md (Design Patterns section)",
        "vault_integration_patterns.md (Integration Patterns section)"
      ]
    },
    "domain_module_testing": {
      "description": "Testing patterns for domain modules post-facade elimination",
      "patterns": [
        "Per-module singleton resets in beforeEach()",
        "Configuration isolation per test",
        "Direct domain module imports in test files"
      ],
      "where_to_add": "testing_guide.md (Domain Module Testing Patterns section)"
    },
    "migration_checklist": {
      "description": "Guidance for future facade-to-modules refactoring",
      "items": [
        "Identify facade responsibilities",
        "Create domain-specific modules",
        "Extract singleton management",
        "Update all references",
        "Validate test isolation",
        "Update memory files"
      ],
      "where_to_add": "code_quality_patterns.md (Breaking Changes section)"
    }
  },
  "validation_script": {
    "path": ".serena/scripts/validate-memories.sh",
    "exists": true,
    "checks": [
      "Issue number references (MCP-##)",
      "Date patterns (YYYY-MM-DD)",
      "File size violations (60-250 lines)",
      "Naming convention violations"
    ],
    "run_after_updates": true
  },
  "ready_for_execution": true,
  "execution_notes": [
    "Do NOT modify any files during Phase 6 - analysis only",
    "Phase 6 deliverable is this JSON plan",
    "Phase 7 will execute updates based on this plan",
    "Validation script will verify memory compliance",
    "All memory files will remain within 250-line limit",
    "New sections will focus on post-MCP-91 patterns"
  ]
}
